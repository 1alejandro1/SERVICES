@using Card_App.Models.Enroll
@using Microsoft.AspNetCore.Authorization
@using System.Web
@inject IAuthorizationService AuthorizationService

@model EnrollViewModel
@{
    ViewData["Title"] = "Enrolar Servicios";
}
<link rel="stylesheet" type="text/css" href="~/css/datatables.min.css" />
<div class="container-fluid">
   @* @if (Model != null && Model.Registro != null && Model.Registro.message == "COMPLETADO")
    {
          <div class="row">
            <div class="col">
                <div class="alert alert-success"> Tarjeta registrada satisfactoriamente con el siguiente mensaje: @Model.Registro.message</div>
            </div>
        </div>
    }else if(Model != null && Model.Registro != null)
    {
        <div class="row">
            <div class="col">
                <div class="alert alert-danger">@Model.Registro.message</div>
            </div>
        </div>
    }
    else
    {
       @* <div class="row">
            <div class="col">
                <div class="alert alert-success">Aún no realizó ningún registro</div>
            </div>
        </div>
    }*@
    <div class="row">
        <div class="col-sm-12">
            <div class="card bg-bgcontent-dark rounded shadow-sm mb-3">
                <div class="col-sm-10"></div>
                <div class="card-header fw-bold">Enrolar Servicios</div>
                <div class="col-sm-10"></div>
                <div class="card-body">
                    <form class="row" asp-action="Enroll" id="frmEnroll">
                        <div class="col-sm-4">
                            <label asp-for="EnrollView.categoryId" class="form-label">Categoría</label>
                            <select id="Producto" asp-for="EnrollView.categoryId" asp-items="Model.CategoriasDropDown" class="form-select form-select-sm">
                                <option selected disabled value="">Elegir...</option>
                            </select>
                            <span asp-validation-for="EnrollView.categoryId" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-12"></div>
                        <div class="card-header fw-bold">Comercio</div>  
                        <div class="col-sm-12"></div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Nombre Comercio</label>
                            <input type="text" asp-for="EnrollView.name" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.name" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Codigo de Comercio</label>
                            <input type="text" asp-for="EnrollView.commerceCode" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.commerceCode" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Nombre Empresa</label>
                            <input type="text" asp-for="EnrollView.businessName" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.businessName" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">NIT</label>
                            <input type="text" asp-for="EnrollView.nit" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.nit" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Teléfono</label>
                            <input type="text" asp-for="EnrollView.phoneNumber" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.phoneNumber" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Ciudad</label>
                            <input type="text" asp-for="EnrollView.city" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.city" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Logo (URL)</label>
                            <input type="text" asp-for="EnrollView.logoUrl" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.logoUrl" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Enlace Red Social</label>
                            <input type="text" asp-for="EnrollView.socialNetworkLink" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.socialNetworkLink" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-12"></div>
                        <div class="card-header fw-bold">Servicio</div>
                        <div class="col-sm-12"></div>                        
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Código de Servicio</label>
                            <input type="text" asp-for="EnrollView.serviceCode" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.serviceCode" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Servicio</label>
                            <input type="text" asp-for="EnrollView.service" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.service" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Descripción</label>
                            <input type="text" asp-for="EnrollView.description" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.description" class="validation-text-danger"></span>
                        </div>
                        <div class="col-2 col-md-3 my-1">
                            <label asp-for="EnrollView.startDate" class="form-label">Fecha Inicio</label>
                            <input type="date" class="date form-control" asp-for="EnrollView.startDate" id="date" data-date-format="yyyy/mm">
                        </div>
                        <div class="col-2 col-md-3 my-1">
                            <label asp-for="EnrollView.endDate" class="form-label">Fecha Fin</label>
                            <input type="date" class="date form-control" asp-for="EnrollView.endDate" id="date" data-date-format="yyyy/mm">
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Texto Descuento</label>
                            <input type="text" asp-for="EnrollView.discountText" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.discountText" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Monto Descuento</label>
                            <input type="text" asp-for="EnrollView.discountAmount" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.discountAmount" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Tipo Descuento</label>
                            <input type="text" asp-for="EnrollView.discountRate" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.discountRate" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Descargo</label>
                            <input type="text" asp-for="EnrollView.disclaimer" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.disclaimer" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Stock</label>
                            <input type="text" asp-for="EnrollView.stock" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.stock" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Tipo</label>
                            <input type="text" asp-for="EnrollView.type" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.type" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Ciudad Servicio</label>
                            <input type="text" asp-for="EnrollView.serviceCity" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.serviceCity" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Url Imagen Grande</label>
                            <input type="text" asp-for="EnrollView.largeImageUrl" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.largeImageUrl" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Plantilla</label>
                            <input type="text" asp-for="EnrollView.template" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.template" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Tipo Código</label>
                            <input type="text" asp-for="EnrollView.codeType" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.codeType" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Formato Código</label>
                            <input type="text" asp-for="EnrollView.socialNetworkLink" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.socialNetworkLink" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">axisX</label>
                            <input type="text" asp-for="EnrollView.axisX" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.axisX" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">axisY</label>
                            <input type="text" asp-for="EnrollView.axisY" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.axisY" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Ancho Código</label>
                            <input type="text" asp-for="EnrollView.codeWidth" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.codeWidth" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Alto Código</label>
                            <input type="text" asp-for="EnrollView.codeHigh" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.codeHigh" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Margen Código</label>
                            <input type="text" asp-for="EnrollView.marginCode" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.marginCode" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Encriptación</label>
                            <input type="text" asp-for="EnrollView.encryption" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.encryption" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2 my-1">
                            <label for="Nombre" class="form-label">Estado Servicio</label>
                            <input type="text" asp-for="EnrollView.serviceState" class="form-control form-control-sm" >
                            <span asp-validation-for="EnrollView.serviceState" class="validation-text-danger"></span>
                        </div>
                        <div class="col-sm-2">
                            <button class="btn btn-primary mt-3 w-100" type="submit" id="btnInsertar">Registrar</button>
                        </div>                        
                        <div class="col-sm-2">
                            <input class="btn btn-primary mt-3 w-100" value="Cancelar" type="button" id="btnCancelar" onclick="Limpiar()">
                        </div>
                    </form>
                </div>
            </div>
        </div>      
    </div>
</div>
<partial name="_Loading" />

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/datatables.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#tblIndiceCobros').dataTable({
                "info": false,
                "lengthMenu": [5, 25, 50],
                "language": {
                    "search": "Filtrar:",
                    "lengthMenu": "Mostar _MENU_",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Atras"
                    }
                }
            });


            $("#btnUpload").click(function () {
                var formData = new FormData();
                var files = $("#FileUpload_FormFile");
                console.log("files");
                console.log(files);
                console.log(files.length);
                for (var i = 0; i < files.length; i++) {
                    if (files[i].value == "" || files[i].value == null) {
                        console.log("error");
                        console.log(files[i].value);
                        console.log(files.length);
                        return false;
                    }
                    else {
                        formData.append(files[i].name, files[i].files[0]);
                        console.log("formData");
                        console.log(formData);
                        console.log(files[i].value);
                    }
                    }
//var formSerializeArray = $("#frmCarga").serializeArray();
//for (var i = 0; i < formSerializeArray.length; i++) {
//  formData.append(formSerializeArray[i].name, formSerializeArray[i].value)
//}
   $.ajax({
       type: 'POST',
       data: formData,
       contentType: false,
       processData: false,
       cache: false,
       url: '/Generated/GeneratedCarga',
       success: function (response) {
           if (response.Success == true) {
               console.log("true");
               return true;
           }
           else {
               console.log("false");
               return false;
           }
       },
       error: function () {
           return false;
       },
       failure: function () {
           return false;
       }
       });
       });
            
    //        $("#btnUpload").click(function () {
    //            var selectFile = ($("#FileUpload_FormFile"))[0].files[0];
    //            console.log("File:");
    //            console.log(selectFile);
    //            var dataString = new FormData();
    //            if (!selectFile) {
    //                alert("No se ha Cargado El Archivo (html)");
    //            }
                
    //            dataString.append("FileUpload_FormFile", selectFile);
    //            console.log("DATA: ");
    //            console.log(dataString);
    //            $.ajax({
    //                url: '@Url.Action("GeneratedCarga","Generated")',
    //                type: "Post",
    //                data: dataString,
    //                contentType: false,
    //                processData: false,
    //                async:true,
    //                success: function (data) {
    //                    if (typeof (data.value) != "undefined") {
    //                        alert(data.Message);
    //                    } else {
    //                        alert("Error No identificado");
    //                    }
    //                },

    //        error: function (data) {

    //        }

    //    });
    //});
        });
        function sendRow(id) {
            let renglonPorEnviar = miArray.find(x => x.id == id);
            $.ajax({
                url: "tu/url",
                data: renglonPorEnviar,
                type: "POST",
                dataType: "Json",
                success: function (data) { }
            });
        };
        $(".btnEdit").on("click", function (e) {
            e.preventDefault();
            HabilitarButtons();
            tr = $(this).closest('tr');
            console.log(tr.find("td:eq(1)").text());
            var ProdOld = tr.find("td:eq(1)").text();
            var valorProdOld = ProdOld.split("-");
            console.log(valorProdOld[0]);
            document.getElementById("ProductoOld").value = valorProdOld[0].replace(/ /g, "");
            document.getElementById("Producto").value = valorProdOld[0].replace(/ /g, "");
            
            if (tr.find("td:eq(2)").text() == "BOB") {
                document.getElementById("rbtMonedaOldBol").checked = true;
                document.getElementById("rbtMonedaOldDol").checked = false;
                document.getElementById("rbtMonedaBol").checked = true;
                document.getElementById("rbtMonedaDol").checked = false;
            }
            else {
                document.getElementById("rbtMonedaOldBol").checked = false;
                document.getElementById("rbtMonedaOldDol").checked = true;
                document.getElementById("rbtMonedaBol").checked = false;
                document.getElementById("rbtMonedaDol").checked = true;
            }
            document.getElementById("Minimo").value = tr.find("td:eq(3)").text();
            document.getElementById("Maximo").value = tr.find("td:eq(4)").text();
            document.getElementById("Promedio").value = tr.find("td:eq(5)").text();
            console.log(tr.find("td:eq(6)").text());
            if (tr.find("td:eq(6)").text() == "true") {
                document.getElementById("cbEstado").checked = true;
            }
            else {
                document.getElementById("cbEstado").checked = false;
            }

        });
        function HabilitarButtons() {
            $("button#btnModificar").attr('disabled', false);
            $("button#btnCarga").attr('disabled', false);
        };
        function DeshabilitarButtons() {
            $("button#btnModificar").attr('disabled', true);
            $("button#btnCarga").attr('disabled', true);
        };
        function Limpiar() {
            DeshabilitarButtons();
            location.reload();
        };
         function Carga() {            
            $("form#frmCarga").attr("action", "@Url.Action("GeneratedCarga", "Generated")");            
            $("form#frmCarga").submit();
            
        };
        function DescargarCarta(){
        let tipo=document.getElementById("UpdateCaso_TipoCarta").value;
        let caso=document.getElementById("UpdateCaso_NroCarta").value;
        window.open(`${urlGetCartaFile}?tipo=${tipo}&nroCaso=${caso}`,"_blank");
};


//async function AJAXSubmit (oFormElement) {
//    var resultElement = oFormElement.elements.namedItem("result");
//    console.log(oFormElement);
//    const formData = new FormData(oFormElement);    
//    console.log(formData);
//    try {
//    const response = await fetch(oFormElement.action, {
//      method: 'POST',
//      body: formData
//    });
//        console.log(response.status);
//    if (response.ok) {
//      window.location.href = '/';
//    }

//    resultElement.value = 'Result: ' + response.status + ' ' + 
//      response.statusText;
//      console.log(resultElement.value);
//    } catch (error) {
//      console.error('Error:', error);
//    }
//  };
//// "use strict";

  function AJAXSubmit (oFormElement) {
    var oReq = new XMLHttpRequest();
      console.log(oReq);
    oReq.onload = function(e) { 
    oFormElement.elements.namedItem("result").value = 
      'Result: ' + this.status + ' ' + this.statusText;
    };
    console.log(oReq);
    var resultElement = oFormElement.elements.namedItem("result").value;
      console.log(oFormElement.action);
      console.log(oFormElement);
    oReq.open("post", oFormElement.action);
    oReq.send(new FormData(oFormElement));
};
function ShowListFiles(){
            HabilitarButtons();
            var input = document.getElementById('Files');
            var output = document.getElementById('fileList');

            output.innerHTML = '<ul>';
            for (var i = 0; i < input.files.length; ++i) {
            output.innerHTML += '<li>' + input.files.item(i).name + '</li>';
            }
            output.innerHTML += '</ul>';
};
    </script>
}
